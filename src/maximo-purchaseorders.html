<!-- Load the Polymer.Element base class and other Polymer components -->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../src/maximo-norecords.html">
<link rel="import" href="shared-styles.html" />


<!-->Control the page's dimensions and scaling</!-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<dom-module id="maximo-purchaseorders">
    <style>
        body {
            margin: 0;
            font-family: 'Roboto', 'Noto', sans-serif;
            line-height: 1.5;
            min-height: 100vh;
            background-color: #1d3649;
        }
    </style>
    <!-- Defines the element's style and local DOM -->
    <template>

        <!--imports shared styles for the template-->
        <style include="shared-styles"></style>

        <!--gets the stored baseUrl and saves as data-->
        <app-localstorage-document key="savedBaseUrl" data="{{baseUrl}}"></app-localstorage-document>
        <app-location route="{{route}}"></app-location>
        <app-route route="{{route}}" pattern="/purchaseorders/:num" data="{{pageData}}"></app-route>

        <!--when the page loades, calls a query for maximo, urlParams is the query, see below-->
        <iron-ajax id="maximoPurchaseOrdersListAjax"
                   with-credentials
                   content-type="application/json"
                   url="{{localBaseUri}}maximo/oslc/os/mxpo"
                   params="[[_urlParams()]]"
                   method="get"
                   handle-as="json"
                   last-response="{{PurchaseOrders}}"
                   on-response="_handleResponse"
                   on-error="_handleError"></iron-ajax>


        <div class="poCard">
            <div class="poTitle">

                <!-- Displays the swap page tags here, pageData.num is fetched below in script, and shows total records-->
                <h id="totalPages">Page [[pageData.num]] of [[totalPages]] ([[totalRecords]] records)</h>
                <!--links to next or previous pages, also fetched from script-->
                <iron-icon on-tap="_prevPageUrl" class="arrow" icon="chevron-left"></iron-icon>
                <iron-icon on-tap="_nextPageUrl" class="arrow" icon="chevron-right"></iron-icon>
                <paper-spinner-lite id="spinner" style="margin: auto;display: block;" active></paper-spinner-lite><br />

                <div class="search">
                    <paper-input label="Search description" id="inputWithButton" on-keypress="_getInput">
                        <iron-icon slot="suffix" icon="search"></iron-icon>
                    </paper-input>
                </div>

                <!-- Filter status -->
                <div style="display:{{fil}}" class="poFilter">
                    <paper-dropdown-menu class="poFilt" label="Status" vertical-offset="55" horizontal-align="left">
                        <paper-listbox slot="dropdown-content" selected="{{status}}" attr-for-selected="value" on-iron-select="_itemSelected" style="width: 200px;">
                            <paper-item value='ALL'>All</paper-item>
                            <paper-item value='CLOSE'>Closed</paper-item>
                            <paper-item value='INPRG'>In Progress</paper-item>
                            <paper-item value='CAN'>Canceled</paper-item>
                            <paper-item value='APPR'>Approved</paper-item>
                            <paper-item value='WAPPR'>Waiting on Approval</paper-item>
                            <paper-item value='HOLD'>Hold</paper-item>
                            <paper-item value='PNDREV'>Pending Revision</paper-item>
                            <paper-item value='REVISD'>Revised</paper-item>
                            <paper-item value='HISTEDIT'>Edited in History</paper-item>
                        </paper-listbox>
                    </paper-dropdown-menu>
                </div>

                <div style="display:{{fil}}" class="poFilter">
                    <paper-dropdown-menu class="poFilt" label="Buyer" vertical-offset="55" horizontal-align="left">
                        <paper-listbox slot="dropdown-content" selected="{{buyer}}" attr-for-selected="value" on-iron-select="_buyerSelected" style="width: 200px;">
                            <paper-item value='ALL'>All orders</paper-item>
                            <paper-item value='MY'>My orders</paper-item>
                        </paper-listbox>
                    </paper-dropdown-menu>
                </div>
            </div>

            <!-- if there is an error it displays here -->
            <template is="dom-if" if="[[error]]">
                <p class="alert-error">[[error]]</p>
            </template>

            <!--this is a repeat dom, witch will create a card for each item in Purchaseorders, and display choosen values depending on item.spi.* in the card-->
            <template is="dom-repeat" items="{{PurchaseOrders.member}}">
                <div class="PurchaseOrdersCard">

                    <iron-icon class="titleIcon" icon="assignment"></iron-icon>
                    <strong>{{item.ponum}}</strong>

                    <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline-block;">Description:<span style="margin:16px -8px 0px 5px;font-weight: normal;">{{item.description}}</span><span style="margin: 16px 0px 0px 16px;"></span></div><br />
                    <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline-block;">Buyer:<span style="margin: 16px -8px 0px 5px;font-weight: normal;">{{item.purchaseagent}}</span><span style="margin: 16px 0px 0px 16px;"></span></div><br />
                    <div id="statusColor" style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline-block;">Status:<span style="margin: 16px -8px 0px 5px;font-weight: normal;">{{item.status_description}}</span><span style="margin: 16px 0px 0px 16px;"></span></div><br>
                    <div class="hideContent">
                        <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline-block;">Vendor:<span style="margin: 16px -8px 0px 5px; font-weight: normal;">{{item.vendor}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                        <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline-block;">Entered by:<span style="margin: 16px -8px 0px 5px;font-weight: normal;">{{item.poline.0.enterby}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                        <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline-block;">Quantity:<span style="margin: 16px -8px 0px 5px;font-weight: normal;">{{item.poline.0.pocost.0.quantity}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                        <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline-block;">Unit cost:<span style="margin: 16px -8px 0px 5px;font-weight: normal;">{{item.poline.0.unitcost}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                        <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline-block;">Linecost:<span style="margin: 16px -8px 0px 5px;font-weight: normal;">{{item.poline.0.linecost}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                        <paper-button id="poView"><a name="purchaseorder" style="text-decoration: none; color: #4178be; padding: 10px;" on-tap="_openOrder" data-attr={{item.poid}} href="http://127.0.0.1:8081/purchaseorder/">Inspect Order<iron-icon data-attr={{item.poid}} icon="search"></iron-icon></a></paper-button>
                        <paper-button id="poView"><a name="status" style="text-decoration: none; color: #4178be; padding: 10px;" on-tap="_openOrder" data-attr={{item.poid}} href="http://127.0.0.1:8081/status/">Status<iron-icon data-attr={{item.poid}} icon="query-builder"></iron-icon></a></paper-button>
                    </div>

                    <div class="hideIcons">
                        <paper-button class="poViewRes"><a name="purchaseorder" style="text-decoration: none; color: #4178be;" on-tap="_openOrder" data-attr={{item.poid}} href="http://127.0.0.1:8081/purchaseorder/"><iron-icon data-attr={{item.poid}} icon="search"></iron-icon></a></paper-button>
                        <paper-button class="poViewRes"><a name="status" style="text-decoration: none; color: #4178be;" on-tap="_openOrder" data-attr={{item.poid}} href="http://127.0.0.1:8081/status/"><iron-icon data-attr={{item.poid}} icon="query-builder"></iron-icon></a></paper-button>
                    </div>


                </div>
            </template>
        </div>

        <div class="noPos" style="display: {{noPos}}">
            <maximo-norecords norecordstext="No matching records were found."></maximo-norecords>
        </div>

    </template>

    <script>
        Polymer({
            is: "maximo-purchaseorders",

            attached: function () {
                if (!this._initialized) {
                    this._initialized = true;
                }
            },
            theOrder: {
                type: String
            },
            baseUri: {
                type: String
            },
            localBaseUri: {
                String
            },
            ready: function () {
                this.localBaseUri = "http://localhost:9080/";
                this.baseUri = sessionStorage.getItem('baseUri');
                this.$.maximoPurchaseOrdersListAjax.generateRequest();
            },

            _getInput(e) {
                if (e.keyCode == 13) {
                    if (e.target.value == "") {
                        this.$.maximoPurchaseOrdersListAjax.params = {

                            'oslc.pageSize': 20, //the number of records on a single page
                            'oslc.select': "ponum,description,name,status,status_description, poid, vendor, purchaseagent, poline{polinenum, itemnum,linecost,enterby, unitcost, pocost{quantity}}", //the fields that will be returned on the response
                            'collectioncount': 5, //also returns the total number of records and pages
                            'oslc.where': 'spi:status in["wappr","appr","can","inprg","close","hold","pndrev","revisd","HISTEDIT"]', //filter for description orders
                            "pageno": 1, //Set the requested page number
                            "lean": 1
                        }
                        this.$.maximoPurchaseOrdersListAjax.generateRequest();
                    }
                    else {

                        this.$.maximoPurchaseOrdersListAjax.params = {

                            'oslc.pageSize': 20, //the number of records on a single page
                            'oslc.select': "ponum,description,name,status,status_description, poid, vendor, purchaseagent, poline{polinenum, itemnum,linecost,enterby, unitcost, pocost{quantity}}", //the fields that will be returned on the response
                            'collectioncount': 5, //also returns the total number of records and pages
                            'oslc.where': 'spi:description in["%' + e.target.value + '%"]', //filter for description orders
                            "pageno": 1, //Set the requested page number
                            "lean": 1
                        }
                        this.$.maximoPurchaseOrdersListAjax.generateRequest();
                    }
                }
            },

            _handleResponse(event) {
                if (event == null || event.detail == null || event.detail.__data == null || event.detail.__data.response == null || event.detail.__data.response.responseInfo == null || event.detail.__data.response.responseInfo.totalCount < 1) {
                    this.noPos = "block";
                    this.totalRecords = 0;
                    this.totalPages = 1;
                }
                else {
                    this.noPos = "none";
                    this.$.spinner.active = false
                    this.set('pageData.num', event.detail.__data.response.responseInfo.pagenum)
                    this.set('totalPages', event.detail.response["responseInfo"]["totalPages"])
                    this.set('totalRecords', event.detail.response["responseInfo"]["totalCount"])
                }
            },
            _handleError(event) {
                this.$.spinner.active = false
                if (event.detail.request.xhr &&
                    event.detail.request.xhr.response &&
                    event.detail.request.xhr.response["Error"] &&
                    event.detail.request.xhr.response["Error"]["message"]) {
                    this.error = event.detail.request.xhr.response["Error"]["message"];
                } else {
                    this.error = "Could not authenticate user"
                }
            },
            // filter status method - in progress
            _itemSelected(e) {
                let statusChosen = this.status;

                switch (e.detail.item.firstChild.data) {
                    case "Approved":
                        statusChosen = "APPR";
                        break;
                    case "Canceled":
                        statusChosen = "CAN";
                        break;
                    case "Closed":
                        statusChosen = "CLOSE";
                        break;
                    case "Hold":
                        statusChosen = "HOLD";
                        break;
                    case "In Progress":
                        statusChosen = "INPRG";
                        break;
                    case "Pending Revision":
                        statusChosen = "PNDREV";
                        break;
                    case "Revised":
                        statusChosen = "REVISD";
                        break;
                    case "Waiting on Approval":
                        statusChosen = "WAPPR";
                        break;
                    case "All":
                        statusChosen = "ALL";
                        break;
                    case "Edited in History":
                        statusChosen = "HISTEDIT"
                        break;
                    default:
                        statusChosen = "ALL";
                        break;
                }

                if (statusChosen == "ALL") {
                    this.$.maximoPurchaseOrdersListAjax.params = {

                        'oslc.pageSize': 20, //the number of records on a single page
                        'oslc.select': "ponum,description,name,status,status_description, poid, vendor, purchaseagent, poline{polinenum, itemnum,linecost,enterby, unitcost, pocost{quantity}}", //the fields that will be returned on the response
                        'collectioncount': 5, //also returns the total number of records and pages
                        'oslc.where': 'spi:status in["wappr","appr","can","inprg","close","hold","pndrev","revisd","HISTEDIT"]', //filter for purchase orders
                        "pageno": 1, //Set the requested page number
                        "lean": 1
                    }
                }
                else {
                    this.$.maximoPurchaseOrdersListAjax.params = {
                        'oslc.pageSize': 20, //the number of records on a single page
                        'oslc.select': "ponum,description,name,status,status_description, poid, vendor, purchaseagent, poline{polinenum, itemnum,linecost,enterby, unitcost, pocost{quantity}}", //the fields that will be returned on the response
                        'collectioncount': 5, //also returns the total number of records and pages
                        'oslc.where': 'spi:status in["' + statusChosen + '"]', //filter for purchase orders based on user's choice
                        "pageno": 1, //Set the requested page number
                        "lean": 1
                    }
                }
                this.$.maximoPurchaseOrdersListAjax.generateRequest();
            },

            _showFilters() {
                if (this.fil == "none" || this.fil == undefined) {
                    this.fil = "inline-block;"
                }
                else {
                    this.fil = "none";
                }

            },

            _buyerSelected(e) {
                let choosenBuyer = this.buyer

                switch (e.detail.item.firstChild.data) {
                    case "All orders":
                        choosenBuyer = "ALL";
                        break;
                    case "My orders":
                        choosenBuyer = "MY";
                        break;
                    default:
                        choosenBuyer = "ALL";
                        break;
                }

                var user = sessionStorage.getItem('whoAmI')
                if (choosenBuyer == "MY") {
                    this.$.maximoPurchaseOrdersListAjax.params = {

                        'oslc.pageSize': 20, //the number of records on a single page
                        'oslc.select': "ponum,description,name,status,status_description, poid, vendor, purchaseagent, poline{polinenum, itemnum,linecost,enterby, unitcost, pocost{quantity}}", //the fields that will be returned on the response
                        'collectioncount': 5, //also returns the total number of records and pages
                        'oslc.where': 'spi:purchaseagent in["' + user + '"]', //filter for purchase orders based on user's choice
                        "pageno": 1, //Set the requested page number
                        "lean": 1
                    }

                } else if (choosenBuyer == "ALL") {
                    this.$.maximoPurchaseOrdersListAjax.params = {

                        'oslc.pageSize': 20, //the number of records on a single page
                        'oslc.select': "ponum,description,name,status,status_description, poid, vendor, purchaseagent, poline{polinenum, itemnum,linecost,enterby, unitcost, pocost{quantity}}", //the fields that will be returned on the response
                        'collectioncount': 5, //also returns the total number of records and pages
                        'oslc.where': 'spi:status in["wappr","appr","can","inprg","close","hold","pndrev","revisd","HISTEDIT"]', //filter for purchase orders
                        "pageno": 1, //Set the requested page number
                        "lean": 1
                    }
                }
                this.$.maximoPurchaseOrdersListAjax.generateRequest();
            },

            _openOrder(item) {
                this.theOrder = item.srcElement.dataAttr;
                localStorage['theOrder'] = this.theOrder;
            },
            _urlParams(pageData) {
                if (pageData == undefined) {
                    return {
                        'oslc.pageSize': 20, //the number of records on a single page
                        'oslc.select': "ponum,description,name,status,status_description, poid, vendor, purchaseagent, poline{polinenum, itemnum,linecost,enterby, unitcost, pocost{quantity}}", //the fields that will be returned on the response
                        'collectioncount': 5, //also returns the total number of records and pages
                        'oslc.where': 'spi:status in["wappr","appr"]', //filter for purchase orders for waiting approval
                        "pageno": 1, //Set the requested page number
                        "lean": 1
                    }
                } else if (pageData !== undefined) {
                    return {
                        'oslc.pageSize': 20, //the number of records on a single page
                        'oslc.select': "ponum,description,name,status,status_description, poid, vendor, purchaseagent, poline{polinenum, itemnum,linecost,enterby, unitcost, pocost{quantity}}", //the fields that will be returned on the response
                        'collectioncount': 5, //also returns the total number of records and pages
                        'oslc.where': 'spi:status in["wappr","appr"]', //filter for purchase orders for waiting approval
                        "pageno": pageData, //Set the requested page number
                        "lean": 1
                    }
                }

            },

            // next/prev methods to change po-pages
            _nextPageUrl: function () {
                let totalPages = this.get('totalPages');
                let page = this.get('pageData.num');
                if (page < totalPages) {
                    page++
                }
                this.$.maximoPurchaseOrdersListAjax.params = this._urlParams(page);
                this.$.maximoPurchaseOrdersListAjax.generateRequest();
                //return `purchaseorders/` + (parseInt(page) + 1).toString()
            },

            _prevPageUrl() {
                let page = this.get('pageData.num');
                if (page > 1) {
                    page -= 1
                }
                this.$.maximoPurchaseOrdersListAjax.params = this._urlParams(page);
                this.$.maximoPurchaseOrdersListAjax.generateRequest();
            }

        });
    </script>
</dom-module>