<!-- Load the Polymer.Element base class -->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="shared-styles.html">

<dom-module id="maximo-purchaseorders">
    <!-- Defines the element's style and local DOM -->
    <template>
        <!--imports shared styles for the template-->
        <style include="shared-styles"></style>
        <!--gets the stored baseUrl and saves as data-->
        <app-localstorage-document key="savedBaseUrl" data="{{baseUrl}}"></app-localstorage-document>
        <app-location route="{{route}}"></app-location>
        <app-route route="{{route}}" pattern="/purchaseorders/:num" data="{{pageData}}"></app-route>
        <!--when the page loades, calls a query for maximo, urlParams is the query, see below-->
        <iron-ajax auto
                   id="maximoPurchaseOrdersListAjax"
                   with-credentials
                   content-type="application/json"
                   url="[[baseUrl]]maximo/oslc/os/mxpo"
                   params="[[_urlParams(pageData.num)]]"
                   method="get"
                   handle-as="json"
                   last-response="{{PurchaseOrders}}"
                   on-response="_handleResponse"
                   on-error="_handleError"></iron-ajax>

        <div id="poList">
            <div id="poListTxt">
                <div>
                    <iron-icon class="titleIcon" icon="list"></iron-icon>
                    <h1 id="poListTitle">Purchase Orders</h1>
                </div>
                <template is="dom-if" if="[[error]]">
                    <!-- if there is an error it displays here -->
                    <p class="alert-error"><strong>Error:</strong> [[error]]</p>
                </template>
                <!-- Displays the swap page tags here, pageData.num is fetched below in script, and shows total records-->
                <h3>Page [[pageData.num]] of [[totalPages]] ([[totalRecords]] records)</h3>
                <!--links to next or previous pages, also fetched from script-->
                <a href="[[_prevPageUrl(pageData.num)]]"><iron-icon class="arrow" icon="chevron-left"></iron-icon></a>
                <a href="[[_nextPageUrl(pageData.num)]]" [[parseInt(pageData.num)+1]]><iron-icon class="arrow" icon="chevron-right"></iron-icon></a>
                <paper-spinner-lite id="spinner" style="margin: auto;display: block;" active></paper-spinner-lite>
            </div>


            <!--this is a repeat dom, witch will create a card for each item in Purchaseorders, and display choosen values depending on item.spi.* in the card-->
            <template is="dom-repeat" items="{{PurchaseOrders.member}}">
                <div class="card">
                    <div class="circle"><span>{{item.ponum}}</span></div><div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline;">
                        Description:<span style="margin: 16px 0px 0px 16px;">{{item.description}}</span>
                        <span style="margin: 16px 0px 0px 16px;"></span>
                    </div><div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline;">Vendor:<span style="margin: 16px 0px 0px 16px;">{{item.vendor}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                    <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline;">Buyer:<span style="margin: 16px 0px 0px 16px;">{{item.purchaseagent}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                    <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline;">Entered by:<span style="margin: 16px 0px 0px 16px;">{{item.poline.0.enterby}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                    <div>
                        <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline;">Status:<span style="margin: 16px 0px 0px 16px;">{{item.status_description}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                        <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline;">Quantity:<span style="margin: 16px 0px 0px 16px;">{{item.poline.0.pocost.0.quantity}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                        <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline;">Unit cost:<span style="margin: 16px 0px 0px 16px;">{{item.poline.0.unitcost}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                        <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline;">Linecost:<span style="margin: 16px 0px 0px 16px;">{{item.poline.0.linecost}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                        <div style="display:inline;"><a name="purchaseorder" href="[[rootPath]]purchaseorder/{{item.poid}}">Edit order >></a></div>
                    </div>
                </div>
            </template>
        </div>

    </template>
    <script>
        // Your new element extends the Polymer.Element base class
        class MaximoPurchaseOrders extends Polymer.Element {
            static get is() { return 'maximo-purchaseorders'; }
            _handleResponse(event) {
                this.$.spinner.active = false
                this.set('totalPages', event.detail.response["responseInfo"]["totalPages"])
                this.set('totalRecords', event.detail.response["responseInfo"]["totalCount"])
            }

            _handleError(event) {
                this.$.spinner.active = false
                if (event.detail.request.xhr &&
                    event.detail.request.xhr.response &&
                    event.detail.request.xhr.response["Error"] &&
                    event.detail.request.xhr.response["Error"]["message"]) {
                    this.error = event.detail.request.xhr.response["Error"]["message"];
                } else {
                    this.error = "Could not authenticate user"
                }
            }

            searchPurchaseOrder() {
                let searchValue = document.getElementById("aaa").value;
                alert(searchValue)
            }

            // the query for maximo
            _urlParams(pageNum) {
                return {
                    'oslc.pageSize': 20, //the number of records on a single page
                    'oslc.select': "ponum,description,name,status,status_description, poid, vendor, purchaseagent, poline{polinenum, itemnum,linecost,enterby, unitcost, pocost{quantity}}", //the fields that will be returned on the response
                    'collectioncount': 5, //also returns the total number of records and pages
                    'oslc.where': 'spi:status in["wappr","appr"]', //filter for purchase orders for waiting approval and approved only
                    "pageno": pageNum, //Set the requested page number
                    "lean": 1
                }
            }
            _nextPageUrl(pagenum) {
                return `purchaseorders/` + (parseInt(pagenum) + 1).toString()
            }

            _prevPageUrl(pagenum) {
                let prevPageNum = parseInt(pagenum)
                if (pagenum > 1) {
                    prevPageNum -= 1
                }
                return `purchaseorders/` + prevPageNum.toString()
            }
        }
        //Now, register your new custom element so the browser can use it
        customElements.define(MaximoPurchaseOrders.is, MaximoPurchaseOrders);
    </script>
</dom-module>