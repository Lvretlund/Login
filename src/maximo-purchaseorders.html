<!-- Load the Polymer.Element base class and other Polymer components -->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<!-->Load css</!-->
<link rel="import" href="shared-styles.html">

<dom-module id="maximo-purchaseorders">
    <!-- Defines the element's style and local DOM -->
    <template>

        <!--imports shared styles for the template-->
        <style include="shared-styles"></style>
        <!--gets the stored baseUrl and saves as data-->
        <app-localstorage-document key="savedBaseUrl" data="{{baseUrl}}"></app-localstorage-document>
        <app-location route="{{route}}"></app-location>
        <app-route route="{{route}}" pattern="/purchaseorders/:num" data="{{pageData}}"></app-route>

        <!--when the page loades, calls a query for maximo, urlParams is the query, see below-->
        <iron-ajax auto
                   id="maximoPurchaseOrdersListAjax"
                   with-credentials
                   content-type="application/json"
                   url="[[baseUrl]]maximo/oslc/os/mxpo"
                   params="[[_urlParams(pageData.num)]]"
                   method="get"
                   handle-as="json"
                   last-response="{{PurchaseOrders}}"
                   on-response="_handleResponse"
                   on-error="_handleError"></iron-ajax>

        <!-->Page title</!-->
        <div class="poTitle">
            <iron-icon class="titleIcon" icon="list"></iron-icon>
            <h1 id="poTitleTxt">Purchase Orders</h1>
        </div>

        <div class="poCard">
            <div class="poTitle">

                <!-- Displays the swap page tags here, pageData.num is fetched below in script, and shows total records-->
                <h id="totalPages">Page [[pageData.num]] of [[totalPages]] ([[totalRecords]] records)</h>
                <!--links to next or previous pages, also fetched from script-->
                <a href="[[_prevPageUrl(pageData.num)]]"><iron-icon class="arrow" icon="chevron-left"></iron-icon></a>
                <a href="[[_nextPageUrl(pageData.num)]]" [[parseInt(pageData.num)+1]]><iron-icon class="arrow" icon="chevron-right"></iron-icon></a>
                <paper-spinner-lite id="spinner" style="margin: auto;display: block;" active></paper-spinner-lite>

                <!-->Status filter</!-->
                <div>
                    <paper-dropdown-menu id="poStatus" label="Status">
                        <paper-listbox slot="dropdown-content" selected="{{status}}" attr-for-selected="value" on-iron-select="_itemSelected">
                            <paper-item value='CLOSE'>Closed</paper-item>
                            <paper-item value='INPRG'>In Progress</paper-item>
                            <paper-item value='CAN'>Canceled</paper-item>
                            <paper-item value='APPR'>Approved</paper-item>
                            <paper-item value='WAPPR'>Waiting on Approval</paper-item>
                            <paper-item value='HOLD'>Hold</paper-item>
                            <paper-item value='PNDREV'>Pending Revision</paper-item>
                            <paper-item value='REVISD'>Revised</paper-item>
                            <paper-item value='HISTEDIT'>Edited in History</paper-item>
                        </paper-listbox>
                    </paper-dropdown-menu>
                </div>
            </div>

            <!-- if there is an error it displays here -->
            <template is="dom-if" if="[[error]]">
                <p class="alert-error">[[error]]</p>
            </template>

            <!--this is a repeat dom, witch will create a card for each item in Purchaseorders, and display choosen values depending on item.spi.* in the card-->
            <template is="dom-repeat" items="{{PurchaseOrders.member}}">
                <div class="PurchaseOrdersCard">
                    <div class="circle"><span>{{item.ponum}}</span></div>
                    <div id="descript" style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline;">
                        Description:<span style="margin:16px -8px 0px 5px;font-weight: normal;">{{item.description}}</span>
                        <span style="margin: 16px 0px 0px 16px;"></span>
                    </div>
                    <div id="poContent">
                        <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline-block;">Vendor:<span style="margin: 16px -8px 0px 5px; font-weight: normal;">{{item.vendor}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                        <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline-block;">Buyer:<span style="margin: 16px -8px 0px 5px;font-weight: normal;">{{item.purchaseagent}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                        <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline-block;">Entered by:<span style="margin: 16px -8px 0px 5px;font-weight: normal;">{{item.poline.0.enterby}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>

                        <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline-block;">Status:<span style="margin: 16px -8px 0px 5px;font-weight: normal;">{{item.status_description}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                        <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline-block;">Quantity:<span style="margin: 16px -8px 0px 5px;font-weight: normal;">{{item.poline.0.pocost.0.quantity}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                        <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline-block;">Unit cost:<span style="margin: 16px -8px 0px 5px;font-weight: normal;">{{item.poline.0.unitcost}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                        <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline-block;">Linecost:<span style="margin: 16px -8px 0px 5px;font-weight: normal;">{{item.poline.0.linecost}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                    </div>
                    <div id="poView"><a name="purchaseorder" style="text-decoration: none; color: #1d3649; padding: 10px;" href="[[rootPath]]purchaseorder/{{item.poid}}">Inspect Order >></a></div>
                    <div id="poView"><a name="status" style="text-decoration: none; color: #1d3649; padding: 10px;" href="[[rootPath]]status/{{item.poid}}">Status >></a></div>
                </div>
            </template>
        </div>
    </template>

    <script>
        // element extends the Polymer.Element base class
        class MaximoPurchaseOrders extends Polymer.Element {
            static get is() { return 'maximo-purchaseorders'; }

            _handleResponse(event) {
                this.$.spinner.active = false
                this.set('totalPages', event.detail.response["responseInfo"]["totalPages"])
                this.set('totalRecords', event.detail.response["responseInfo"]["totalCount"])
            }

            _handleError(event) {
                this.$.spinner.active = false
                if (event.detail.request.xhr &&
                    event.detail.request.xhr.response &&
                    event.detail.request.xhr.response["Error"] &&
                    event.detail.request.xhr.response["Error"]["message"]) {
                    this.error = event.detail.request.xhr.response["Error"]["message"];
                } else {
                    this.error = "Could not authenticate user"
                }
            }
            // filter status method - in progress
            _itemSelected() {
                console.log(this.status);
            }

            // the query for maximo
            _urlParams(pageNum) {
                return {
                    'oslc.pageSize': 20, //the number of records on a single page
                    'oslc.select': "ponum,description,name,status,status_description, poid, vendor, purchaseagent, poline{polinenum, itemnum,linecost,enterby, unitcost, pocost{quantity}}", //the fields that will be returned on the response
                    'collectioncount': 5, //also returns the total number of records and pages
                    'oslc.where': 'spi:status in["wappr"]', //filter for purchase orders for waiting approval
                    "pageno": pageNum, //Set the requested page number
                    "lean": 1
                }
            }

            // next/prev methods to change po-pages
            _nextPageUrl(pagenum) {
                let totalPages = this.get('totalPages');
                if (pagenum >= totalPages) {
                    pagenum = 0;
                }
                return `purchaseorders/` + (parseInt(pagenum) + 1).toString()
            }

            _prevPageUrl(pagenum) {
                let prevPageNum = parseInt(pagenum)
                if (pagenum > 1) {
                    prevPageNum -= 1
                }
                return `purchaseorders/` + prevPageNum.toString()
            }
        }

        //Now, register your new custom element so the browser can use it
        customElements.define(MaximoPurchaseOrders.is, MaximoPurchaseOrders);
    </script>
</dom-module>