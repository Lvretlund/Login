<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="shared-styles.html">

<dom-module id="maximo-purchaseorder">
    <!-- Defines the element's style and local DOM -->
    <template>
        <!--imports shared styles for the template-->
        <style include="shared-styles">
        </style>
        <!--gets the stored baseUrl and saves as data-->
        <app-localstorage-document key="savedBaseUrl" data="{{baseUrl}}"></app-localstorage-document>
        <app-location route="{{route}}"></app-location>
        <app-route route="{{route}}" pattern="/purchaseorder/:poRef" data="{{pageData}}"></app-route>
        <!--when the page loades, calls a query for maximo, urlParams is the query, see below-->
        <iron-ajax auto
                   id="maximoLoadPurchaseOrderAjax"
                   with-credentials
                   method="get"
                   handle-as="json"
                   content-type="application/json"
                   url="[[baseUrl]]maximo/oslc/os/mxpo/{{pageData.poRef}}"
                   last-response="{{purchaseOrder}}"
                   on-response="_handleLoadResponse"
                   on-error="_handleLoadError"></iron-ajax>
        <!--when wh run savepurchaseorder, this iron ajax post is executed,it posts to maximo-po where poID is equal to choosen below-->
        <iron-ajax id="maximoSavePurchaseOrderAjax"
                   with-credentials
                   url="[[baseUrl]]maximo/oslc/os/mxpo/{{purchaseOrder.spi:poid}}"
                   method="post"
                   handle-as="json"
                   content-type="application/json"
                   last-response="{{purchaseOrder}}"
                   on-response="_handleSaveResponse"
                   on-error="_handleSaveError"></iron-ajax>
        <paper-spinner-lite id="spinner" style="margin: auto;display: block;"></paper-spinner-lite>
        <template is="dom-if" if="{{!(spinner.active)}}">
            <div class="card">
                <template is="dom-if" if="[[error]]">
                    <!-- if there is an error it displays here -->
                    <p class="alert-error"><strong>Error:</strong> [[error]]</p>
                </template>
                <template is="dom-if" if="[[success]]">
                    <!-- if success, it displays here -->
                    <p class="alert-success"><strong>Sucess:</strong> [[success]]</p>
                </template>
                <!--displays some choosen values of the order as a header -->
                <h3> Detailed information regarding order [[purchaseOrder.spi:ponum]] </h3>
                <form action="/foo" method="get">
                    <!--display some choosen values regarding the order, wich we want to be able to edit. -->
                    <div class="card" style="margin-bottom: 5em;">
                        <div>
                            <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline;">
                                Order Information:<span style="margin: 16px 0px 0px 16px;">{{Purchaseorder.spi:description}}</span>
                                <span style="margin: 16px 0px 0px 16px;"></span>
                            </div>
                        </div>
                        <div class="circle" label"><span>{{purchaseOrder.spi:ponum}}</span></div>
                        <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline;">Vendor:<span style="margin: 16px 0px 0px 16px;">{{purchaseOrder.spi:vendor}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                        <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline;">Buyer:<span style="margin: 16px 0px 0px 16px;">{{purchaseOrder.spi:purchaseagent}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                        <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline;">
                            Entered by:<span style="margin: 16px 0px 0px 16px;">{{purchaseOrder.spi:poline.0.spi:enterby}}</span><span style="margin: 16px 0px 0px 16px;"></span>
                            <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline;">Status:<span style="margin: 16px 0px 0px 16px;">{{purchaseOrder.spi:status_description}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                            <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline;">Total Cost:<span style="margin: 16px 0px 0px 16px;">{{purchaseOrder.spi:totalcost}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                            <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline;">Order Type:<span style="margin: 16px 0px 0px 16px;">{{purchaseOrder.spi:potype}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>

                        </div>
                    </div>
                    <div class="card">
                        <div>
                            <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline;">
                                Line Information:<span style="margin: 16px 0px 0px 16px;">{{Purchaseorder.spi:description}}</span>
                                <span style="margin: 16px 0px 0px 16px;"></span>
                            </div>
                        </div>
                        <div>
                            <div class="circle"><span>{{purchaseOrder.spi:poline.0.spi:itemnum}}</span></div>
                            <!--<div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline;">Order Quantity:<span style="margin: 16px 0px 0px 16px;">{{purchaseOrder.spi:poline.0.spi:pocost.0.spi:quantity}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>-->
                            <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline;">Line Quantity:<span style="margin: 16px 0px 0px 16px;">{{purchaseOrder.spi:poline.0.spi:orderqty}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                            <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline;">Unit cost:<span style="margin: 16px 0px 0px 16px;">{{purchaseOrder.spi:poline.0.spi:unitcost}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                            <div style="margin: 16px 0px 0px 0px;font-weight: bold;display:inline;">Linecost:<span style="margin: 16px 0px 0px 16px;">{{purchaseOrder.spi:poline.0.spi:linecost}}</span><span style="margin: 16px 0px 0px 16px;"></span></div>
                        </div>

                    </div>



                    <!--<paper-input disabled type="number" required label="Purchase Order Quantity" value="{{purchaseOrder.spi:poline.0.spi:pocost.0.spi:quantity}}"></paper-input>
                    <paper-button raised class="indigo" raised on-tap="increasePurchaseOrderQty">Increase purchase order quantity</paper-button>&nbsp;<paper-spinner-lite id="spinner"></paper-spinner-lite>
                    <paper-button raised class="indigo" raised on-tap="decreasePurchaseOrderQty">Decrease purchase order quantity</paper-button>&nbsp;<paper-spinner-lite id="spinner"></paper-spinner-lite>-->
                    <paper-input disabled type="number" required label="Purchase Order Line Quantity" value="{{purchaseOrder.spi:poline.0.spi:orderqty}}"></paper-input>
                    <paper-button raised class="indigo" raised on-tap="increasePurchaseOrderLineQty">Increase purchase order line quantity</paper-button>&nbsp;<paper-spinner-lite id="spinner"></paper-spinner-lite>
                    <paper-button raised class="indigo" raised on-tap="decreasePurchaseOrderLineQty">Decrease purchase order line quantity</paper-button>&nbsp;<paper-spinner-lite id="spinner"></paper-spinner-lite>
                    <div>
                        <paper-dropdown-menu id="poStatus"
                                             label="Status">
                            <paper-listbox id="dropdown" slot="dropdown-content" selected="{{purchaseOrder.spi:status}}" attr-for-selected="value">
                                <paper-item disabled="{{disabled}}" value='CLOSE'>Closed</paper-item>
                                <paper-item disabled="{{disabled}}" value='INPRG'>In Progress</paper-item>
                                <paper-item disabled="{{disabled}}" value='CAN'>Canceled</paper-item>
                                <!--Order statuses avaliable but that should not be used (right now)-->
                                <!--<paper-item value='APPR'>Approved</paper-item>
                                <paper-item value='WAPPR'>Waiting on Approval</paper-item>
                                <paper-item value='HOLD'>Hold</paper-item>
                                <paper-item value='PNDREV'>Pending Revision</paper-item>
                                <paper-item value='REVISD'>Revised</paper-item>
                                <paper-item value='HISTEDIT'>Edited in History</paper-item>-->
                            </paper-listbox>
                        </paper-dropdown-menu>
                    </div>
                    <paper-input type="text" required label="Status date" value="{{purchaseOrder.spi:statusdate}}"></paper-input>
                    <paper-input type="text" required label="Ordered date" value="{{purchaseOrder.spi:orderdate}}"></paper-input>
                    <paper-input type="text" required label="Required date" value="{{purchaseOrder.spi:requireddate}}"></paper-input>
                    <paper-button raised class="indigo" raised on-tap="savePurchaseOrder">Save</paper-button>&nbsp;<paper-spinner-lite id="spinner"></paper-spinner-lite>
                </form>
            </div>
        </template>
    </template>
    <script>
        class MaximoPurchaseOrder extends Polymer.Element {
            static get is() { return 'maximo-purchaseorder'; }

            static get properties() {
                return {
                    baseUrl: {
                        type: String,
                        observer: '_baseUrlChanged',
                    },
                    workOrder: {
                        type: Object,
                        value: {},
                        notify: true
                    },
                    whoAmI: {
                        type: Object,
                        observer: '_whoAmIChanged',
                    },
                    disabled: {
                        type: Boolean,
                        notify: true,
                        reflectToAttribute: true
                    }

                }
            }

            static get observers() {
                return [
                    '_poRefChanged(pageData)'
                ]
            }

            _showDetails() {
                if (parseInt(this.get('pageData.poRef')) > 0) {
                    return true
                }

                return false
            }


            _poRefChanged(pageData) {
                //if we have a valid id, load the related wo data
                if (this._showDetails()) {
                    this.$.spinner.active = true
                    this.$.maximoLoadPurchaseOrderAjax.generateRequest()

                } else {
                    this.set('purchaseOrder', {})
                    this.set('purchaseOrder.spi:orgid', this.get('whoAmI.defaultOrg') || '')
                    this.set('purchaseOrder.spi:siteid', this.get('whoAmI.defaultSite') || '')
                }

            }


            _poLoaded() {
                //checking if the loaded order has a workorder binded to it, to prevent statuschange if the wo does not allow it
                let checkWO = (this.get('purchaseOrder.spi:poline.0.spi:refwo'))
                if (typeof checkWO === 'string' || checkWO instanceof String) {
                    this.disabled = true;
                } else {
                    this.disabled = false;
                }
            }

            //After the whoAmI object is populated, we need to populate those fields
            _whoAmIChanged() {
                if (!this._showDetails()) {
                    this.set('purchaseOrder.spi:orgid', this.get('whoAmI.defaultOrg') || '')
                    this.set('purchaseOrder.spi:siteid', this.get('whoAmI.defaultSite') || '')
                }
            }

            _baseUrlChanged() {
                if (this._showDetails()) {
                    this.$.spinner.active = true
                    this.$.maximoLoadPurchaseOrderAjax.generateRequest()
                }
            }

            _handleLoadResponse(event) {
                this.$.spinner.active = false
                this._poLoaded(this.get('purchaseOrder'))
            }

            _handleLoadError(event, request) {
                this.$.spinner.active = false
            }

            _handleSaveResponse(event) {
                this.$.spinner.active = false
                if (!this._showDetails()) {
                    this.set('route.path', '/purchaseorder/' + this.get('purchaseOrder.spi:purchaseorderid'))
                } else {
                    this.error = null;
                    this.success = "Work Order Successfully Saved"
                }
            }

            _handleSaveError(event, request) {
                this.$.spinner.active = false
                if (event.detail.request.xhr &&
                    event.detail.request.xhr.response &&
                    event.detail.request.xhr.response["oslc:Error"] &&
                    event.detail.request.xhr.response["oslc:Error"]["oslc:message"]) {
                    this.error = event.detail.request.xhr.response["oslc:Error"]["oslc:message"];
                    this.success = null;
                } else {
                    this.error = "Could not save Purchase Order"
                    this.success = null;
                }
            }

            _getSaveHeaders() {
                let headers = { 'properties': '*' }
                if (this._showDetails()) {
                    headers['x-method-override'] = 'PATCH'
                }
                return headers
            }

            //this function increases the purchase order quantity, and also increases the PO-line quantity
            increasePurchaseOrderQty() {

                let getPoCostQty = this.get('purchaseOrder.spi:poline.0.spi:pocost.0.spi:quantity')
                let poCostQty = parseInt(getPoCostQty)
                poCostQty++
                let getPoLineQty = this.get('purchaseOrder.spi:poline.0.spi:orderqty')
                let poLineQty = parseInt(getPoLineQty)
                poLineQty++

                this.set('purchaseOrder.spi:poline.0.spi:pocost.0.spi:quantity', poCostQty)
                this.set('purchaseOrder.spi:poline.0.spi:orderqty', poLineQty)

                //also, if the quantity increases, so should the cost

                let poLineCost = parseInt(this.get('purchaseOrder.spi:poline.0.spi:linecost'))
                let poUnitCost = parseInt(this.get('purchaseOrder.spi:poline.0.spi:unitcost'))

                poLineCost += poUnitCost

                this.set('purchaseOrder.spi:poline.0.spi:linecost', poLineCost)



            }
            //this function decreases the purchase order quantity, and also decreases the PO-line quantity
            decreasePurchaseOrderQty() {
                let getPoCostQty = this.get('purchaseOrder.spi:poline.0.spi:pocost.0.spi:quantity');
                let poCostQty = parseInt(getPoCostQty);
                poCostQty--;;
                let getPoLineQty = this.get('purchaseOrder.spi:poline.0.spi:orderqty');
                let poLineQty = parseInt(getPoLineQty);
                poLineQty--;

                this.set('purchaseOrder.spi:poline.0.spi:pocost.0.spi:quantity', poCostQty)
                this.set('purchaseOrder.spi:poline.0.spi:orderqty', poLineQty)

                //also, if the quantity decreases, so should the cost

                let poLineCost = parseInt(this.get('purchaseOrder.spi:poline.0.spi:linecost'))
                let poUnitCost = parseInt(this.get('purchaseOrder.spi:totalcost'))

                poLineCost -= poUnitCost

                this.set('purchaseOrder.spi:poline.0.spi:linecost', poLineCost)

            }

            //this function increases the purchase order line quantity
            increasePurchaseOrderLineQty() {
                let getPoLineQty = parseInt(this.get('purchaseOrder.spi:poline.0.spi:orderqty'));
                getPoLineQty++
                this.set('purchaseOrder.spi:poline.0.spi:orderqty', getPoLineQty)

                let poUnitCost = parseInt(this.get('purchaseOrder.spi:poline.0.spi:unitcost'))
                let poLineCost = parseInt(this.get('purchaseOrder.spi:poline.0.spi:linecost'))
                let poTotalCost = parseInt(this.get('purchaseOrder.spi:totalcost'))

                poLineCost = poLineCost + poUnitCost
                poTotalCost = poTotalCost + poUnitCost
                this.set('purchaseOrder.spi:poline.0.spi:linecost', poLineCost)
                this.set('purchaseOrder.spi:totalcost', poTotalCost)

            }

            //this function decreases the purchase order line quantity
            decreasePurchaseOrderLineQty() {
                let getPoLineQty = parseInt(this.get('purchaseOrder.spi:poline.0.spi:orderqty'));
                getPoLineQty--
                this.set('purchaseOrder.spi:poline.0.spi:orderqty', getPoLineQty)

                let poUnitCost = parseInt(this.get('purchaseOrder.spi:poline.0.spi:unitcost'))
                let poLineCost = parseInt(this.get('purchaseOrder.spi:poline.0.spi:linecost'))
                let poTotalCost = parseInt(this.get('purchaseOrder.spi:totalcost'))

                poLineCost = poLineCost - poUnitCost
                poTotalCost = poTotalCost - poUnitCost
                this.set('purchaseOrder.spi:poline.0.spi:linecost', poLineCost)
                this.set('purchaseOrder.spi:totalcost', poTotalCost)
            }

            _getSavePayload(purchaseOrder) {
                // format the input-string to an integer before updating
                let getPoCostQty = this.get('purchaseOrder.spi:poline.0.spi:pocost.0.spi:quantity');
                let poCostQty = parseInt(getPoCostQty);
                let getPoLineQty = this.get('purchaseOrder.spi:poline.0.spi:orderqty');
                let poLineQty = parseInt(getPoLineQty);

                this.set('purchaseOrder.spi:poline.0.spi:pocost.0.spi:quantity', poCostQty)
                this.set('purchaseOrder.spi:poline.0.spi:orderqty', poLineQty)

                return purchaseOrder
            }

            //this is the save order function, wich calls to the iron ajax element with save order ID.
            savePurchaseOrder() {
                this.error = null;
                this.success = null;
                this.$.maximoSavePurchaseOrderAjax.headers = this._getSaveHeaders()
                this.$.maximoSavePurchaseOrderAjax.body = this._getSavePayload(this.get('purchaseOrder'))
                this.$.maximoSavePurchaseOrderAjax.generateRequest()
                this.$.spinner.active = true
            }
        }

        window.customElements.define(MaximoPurchaseOrder.is, MaximoPurchaseOrder);
    </script>
</dom-module>
