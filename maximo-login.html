<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">

<dom-module id="maximo-login">
    <template>

        <app-localstorage-document key="savedBaseUrl" data="{{baseUrl}}"></app-localstorage-document>
        <iron-ajax id="maximoLoginAjax" with-credentials content-type="application/json" url="[[baseUrl]]maximo/oslc/login" method="post"
                   handle-as="json" on-response="_handleLoginResponse" on-error="_handleLoginError"></iron-ajax>

        <iron-ajax auto
                   with-credentials
                   content-type="application/json"
                   url="[[baseUrl]]maximo/oslc/whoami"
                   method="get"
                   handle-as="json"
                   content-type="application/json"
                   last-response="{{whoAmI}}"
                   on-response="_handleResponse"
                   on-error="_handleError"
                   debounce-duration="1000"></iron-ajax>

        <h1>IBM MAXIMOOOO</h1>
        <h2>Enterprise Asset Management</h2>
        <iron-form id="form1">
            <form action="/foo" method="get">
                <paper-input id="username" type="text" name="username" required label="Username" value="{{username}}"></paper-input>
                <paper-input id="password" type="password" name="password" required label="Password" value="{{password}}"></paper-input>
                <paper-input id="maximoBaseUrl" type="text" name="maximoUrl" required label="Maximo URL" value="{{baseUrl}}"></paper-input>
                <paper-button raised class="indigo" on-tap="performLogin">Sign In</paper-button>&nbsp;
            </form>
        </iron-form>

    </template>

    <script>
        class MaximoLogin extends Polymer.Element {
            static get is() {
                return 'maximo-login';
            }

            performLogin() {
                let baseUrl = this.get('baseUrl')
                if (!(baseUrl.toLowerCase().startsWith('http://'))
                    && !(baseUrl.toLowerCase().startsWith('https://'))) {
                    this.$.spinner.active = false
                    this.error = `The URL ${baseUrl} is malformed, please add the protocol information at the beginning.`
                } else {
                    //if the given URL doesn't end with a /, add one
                    if (baseUrl[baseUrl.length - 1] !== '/') {
                        baseUrl = baseUrl + '/'
                    }
                    this.set('baseUrl', baseUrl)
                    this.$.maximoLoginAjax.headers['maxAuth'] = btoa(`${this.get('username')}:${this.get('password')}`)
                    this.$.maximoLoginAjax.generateRequest()
                }
            }

            _handleLoginResponse(event) {
                this.dispatchEvent(new CustomEvent('authenticated', {
                    bubbles: true,
                    composed: true
                }))
                alert("gfgfgg");
            }

            _handleResponse(event) {
                this.set('authenticated', true)
                // the user is already authenticated, 
                // if it is on login page and has a valid whoAmI response, redirect to the wo list
                if ((this.get('route.path') === '/login' || this.get('route.path') === '/') && this.get('whoAmI'))
                    this.set('route.path', '/work-orders-list/1')
            }
        }
        window.customElements.define(MaximoLogin.is, MaximoLogin);
    </script>
</dom-module>